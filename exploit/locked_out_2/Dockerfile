ARG DOCKER_REGISTRY
FROM $DOCKER_REGISTRY/chad/challbase

RUN apk --no-cache add musl-dev gcc make socat
RUN apk --no-cache add pwgen

COPY pre-drop.sh /etc/challbase/

WORKDIR /opt/locked_out
COPY meme.jpg .
COPY src/ /opt/locked_out/src

RUN apk --no-cache add python3 && \
    make -C src/ && \
    apk --no-cache del python3

EXPOSE 1337/tcp
CMD ["socat", "-v", "tcp-listen:1337,fork,reuseaddr", "exec:locked_out,cfmakeraw,stderr,pty,ctty,setsid"]
